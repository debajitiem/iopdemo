/*
 * Command line: gradle -PiibEnv=QA|PROD|DEV Ant Target (e.g. deploy, compile, * test)
 * or place in gradle.properties file.
 * The deployOnly property can be set to 'true' if an existing BAR file
 * has to be deployed only; not first compiled.
 */


 if (org.gradle.internal.os.OperatingSystem.current().windows) {

       ant.properties['mqsi.deploy'] = 'mqsideploy.exe'
       ant.properties['mqsi.createbar'] = 'mqsicreatebar.exe'
       ant.properties['iib.path'] = ext.mqsiprofilePathWin

   } else {

       ant.properties['mqsi.deploy'] = 'mqsideploy'
       ant.properties['mqsi.createbar'] = 'mqsicreatebar'
       ant.properties['iib.path'] = ext.mqsiprofilePathUnix
}

switch (iibEnv) {

         case "PROD":
          ant.properties['iib.node.specfile'] = 'iib-node-prod.xml'
          ant.properties['iib.override.file'] = 'override-prod.properties'
          break;
         case "QA":
          ant.properties['iib.node.specfile'] = 'iib-node-qa.xml'
          ant.properties['iib.override.file'] = 'override-qa.properties'
          break;
         default:
         ant.properties['iib.node.specfile'] = 'iib-node.xml'
         ant.properties['iib.override.file'] = 'override.properties'
}

//Read from a properties file, details of Integration Nodes (brokers) to which the BAR file must be deployed
ext.brokerFile = file('broker.properties')

//Set Ant properties from gradle properties read from properties file

ant.properties['iib.barfile.dir']=ext.barfileDir
ant.properties['iib.svr']=ext.intServer
ant.properties['iib.bar.version']=ext.barFileVersion
ant.properties['iib.app']=ext.appName
ant.properties['iib.mqsicreatebar.params']=ext.paramsMQSICreateBarfile

ant.importBuild 'build.xml'

task multiDeploy() {

  Properties brokers = readBrokers()

  doLast {

  String[] brokerElems
  def iNode, hostName, Port, iServer

  brokers.each{ key, value ->

    brokerElems = value.split(':')

  //Not very elegant, but here goes ...
    iNode = brokerElems[0]
    hostName = brokerElems[1]
    Port = brokerElems[2]
    iServer = brokerElems[3]

    ant.mdeploy(inode: iNode,
                hostname: hostName,
                port: Port,
                execgroup: iServer)
    }
  }
}

Properties readBrokers() {

 logger.quiet 'Reading the brokers file.'

 if (!ext.brokerFile.exists()) {
     throw new GradleException(
     "Required broker file does not exist: $brokerFile.canonicalPath")
 }
 Properties brokerProps = new Properties()
 brokerFile.withInputStream { stream -> brokerProps.load(stream) }
  return brokerProps
}

multiDeploy.dependsOn('compile', 'override')
